<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elliptic Curve</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calculator.css') }}">
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">Calculating...</div>
            <div class="loading-details"></div>
        </div>
    </div>

    <!-- History Panel Overlay -->
    <div id="historyOverlay" class="history-overlay" onclick="closeHistoryPanel()"></div>

    <!-- Sliding History Panel -->
    <div id="historyPanel" class="history-panel">
        <div class="history-panel-header">
            <h2><i class="fa-solid fa-gear panel-title-icon" aria-hidden="true"></i> Menu</h2>
            <button class="history-close-btn" onclick="closeHistoryPanel()" aria-label="Close menu panel">×</button>
        </div>
        <div class="history-panel-content">

            <!-- User Profile Section -->
            <div class="menu-section">
                <div class="menu-section-header">
                        <div class="user-profile-card">
                            <div class="user-avatar"><i class="fa-solid fa-circle-user" aria-hidden="true"></i></div>
                        <div class="user-info">
                            <div class="user-name" id="menuUserName">Guest</div>
                            <div class="user-status" id="menuUserStatus">Not signed in</div>
                        </div>
                    </div>
                    <button id="menuAuthBtn" class="btn-auth" onclick="openLoginModal()">Sign In</button>
                </div>
            </div>

            <!-- Quick Actions Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Quick Actions</h3>
                    <div class="menu-grid">
                        <button class="menu-card" onclick="toggleTheme()" title="Toggle light/dark theme">
                            <span class="menu-card-icon theme-icon"><i class="fa-solid fa-moon" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Theme</span>
                        <span class="menu-card-hint">Toggle mode</span>
                    </button>
                        <button class="menu-card" onclick="showKeyboardHelp()" title="View keyboard shortcuts">
                            <span class="menu-card-icon"><i class="fa-solid fa-keyboard" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Shortcuts</span>
                        <span class="menu-card-hint">View all</span>
                    </button>
                        <button class="menu-card" onclick="showFormulaReference()" title="Mathematical formulas">
                            <span class="menu-card-icon"><i class="fa-solid fa-ruler-combined" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Formulas</span>
                        <span class="menu-card-hint">Reference</span>
                    </button>
                        <button class="menu-card" onclick="exportUnifiedHistory()" title="Export history">
                            <span class="menu-card-icon"><i class="fa-solid fa-file-export" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Export</span>
                        <span class="menu-card-hint">Save data</span>
                    </button>
                </div>
            </div>

            <!-- Learning & Tutorials Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Learning & Tutorials</h3>
                <div class="menu-grid">
                    <button class="menu-card" onclick="startTutorial('initialization')" title="Learn curve initialization">
                        <span class="menu-card-icon"><i class="fa-solid fa-graduation-cap" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Init Tutorial</span>
                        <span class="menu-card-hint">Step-by-step</span>
                    </button>
                    <button class="menu-card" onclick="startTutorial('point_addition')" title="Learn point addition">
                        <span class="menu-card-icon"><i class="fa-solid fa-book-open" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Addition Tutorial</span>
                        <span class="menu-card-hint">Guided walkthrough</span>
                    </button>
                    <button class="menu-card" onclick="startTutorial('scalar_multiplication')" title="Learn scalar multiplication">
                        <span class="menu-card-icon"><i class="fa-solid fa-chalkboard-teacher" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Multiply Tutorial</span>
                        <span class="menu-card-hint">Interactive guide</span>
                    </button>
                    <button class="menu-card" onclick="showPresetsLibrary()" title="Manage curve presets">
                        <span class="menu-card-icon"><i class="fa-solid fa-bookmark" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Presets Library</span>
                        <span class="menu-card-hint">Save & load</span>
                    </button>
                </div>
            </div>

            <!-- Advanced Features Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Advanced Features</h3>
                <div class="menu-grid">
                    <button class="menu-card" onclick="classifyPoints()" title="Classify curve points">
                        <span class="menu-card-icon"><i class="fa-solid fa-layer-group" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Classify</span>
                        <span class="menu-card-hint">Point types</span>
                    </button>
                    <button class="menu-card" onclick="demonstrateDiffieHellman()" title="Diffie-Hellman key exchange">
                        <span class="menu-card-icon"><i class="fa-solid fa-key" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Diffie-Hellman</span>
                        <span class="menu-card-hint">Key exchange</span>
                    </button>
                    <button class="menu-card" onclick="demonstrateDiscreteLog()" title="Discrete logarithm problem">
                        <span class="menu-card-icon"><i class="fa-solid fa-calculator" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Discrete Log</span>
                        <span class="menu-card-hint">Interactive demo</span>
                    </button>
                    <button class="menu-card" onclick="showWhyItWorksModal()" title="Learn how ECC works">
                        <span class="menu-card-icon"><i class="fa-solid fa-lightbulb" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Why It Works</span>
                        <span class="menu-card-hint">Learn ECC</span>
                    </button>
                </div>
            </div>

            <!-- Utility Tools Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Utility Tools</h3>
                <div class="menu-grid">
                    <button class="menu-card" onclick="generateTestVector()" title="Generate test vector">
                        <span class="menu-card-icon"><i class="fa-solid fa-vial" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Test Vector</span>
                        <span class="menu-card-hint">Generate</span>
                    </button>
                    <button class="menu-card" onclick="copyCurveParameters()" title="Copy curve parameters">
                        <span class="menu-card-icon"><i class="fa-solid fa-copy" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Copy Params</span>
                        <span class="menu-card-hint">To clipboard</span>
                    </button>
                    <button class="menu-card" onclick="downloadPointList()" title="Download point list">
                        <span class="menu-card-icon"><i class="fa-solid fa-download" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Download</span>
                        <span class="menu-card-hint">Point list</span>
                    </button>
                    <button class="menu-card" onclick="toggleCurveOverlay()" title="Compare multiple curves">
                        <span class="menu-card-icon"><i class="fa-solid fa-layer-plus" aria-hidden="true"></i></span>
                        <span class="menu-card-label">Overlay</span>
                        <span class="menu-card-hint">Compare curves</span>
                    </button>
                </div>
            </div>

            <!-- History Section -->
            <div class="menu-section">
                <div class="menu-section-title-row">
                        <h3 class="menu-section-title"><i class="fa-solid fa-scroll menu-title-icon" aria-hidden="true"></i> History</h3>
                        <div class="menu-section-actions">
                            <button class="icon-btn" onclick="refreshUnifiedHistory()" title="Refresh history">
                                <span aria-hidden="true"><i class="fa-solid fa-arrows-rotate"></i></span>
                            </button>
                            <button class="icon-btn" onclick="clearUnifiedHistory()" title="Clear history">
                                <span aria-hidden="true"><i class="fa-solid fa-trash-can"></i></span>
                            </button>
                        </div>
                    </div>
                <div id="unifiedHistoryList" class="history-list"></div>
            </div>

        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="info-btn" onclick="toggleAboutModal()" title="About & Help" aria-label="About and help">
                <span class="info-icon"><i class="fa-solid fa-circle-info" aria-hidden="true"></i></span>
            </button>
            <h1>Elliptic Curve</h1>
            <div class="header-buttons">
                <button class="history-toggle" onclick="toggleHistoryPanel()" title="Menu" aria-label="Open menu panel">
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                </button>
            </div>
        </div>

        <!-- Auth Overlay -->
        <div id="authOverlay" class="auth-overlay">
            <div class="auth-card">
                <div style="text-align:center;">
                    <div class="auth-icon" aria-hidden="true"><i class="fa-solid fa-lock" aria-hidden="true"></i></div>
                    <div class="auth-title">Sign in</div>
                    <div class="auth-sub">Access your elliptic curve workspace.</div>
                </div>
                <div class="auth-form">
                    <div class="auth-field">
                        <svg class="auth-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>
                        <input id="loginUsername" type="text" placeholder="Username">
                        <div id="loginUsernameErr" class="field-error" style="display:none;"></div>
                    </div>
                    <div class="auth-field">
                        <svg class="auth-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm6-6V9a6 6 0 1 0-12 0v2H4v10h16V11h-2zm-8-2a4 4 0 1 1 8 0v2H10V9z"/></svg>
                        <input id="loginPassword" type="password" placeholder="Password">
                        <div id="loginPasswordErr" class="field-error" style="display:none;"></div>
                    </div>
                    <div class="auth-right-row">
                        <a class="auth-right-link" href="#" onclick="alert('Reset link flow not implemented')">Forgot password?</a>
                    </div>
                    <button class="btn-primary-dark" onclick="submitLoginCard()">Get Started</button>
                    <div class="auth-sep"><div class="line"></div><div class="txt">Or</div><div class="line"></div></div>
                    <div class="btn-row">
                        <button class="btn-pill secondary" onclick="openSignupPage()">Create an account</button>
                        <button class="btn-pill ghost" onclick="continueAsGuestCard()">Continue as guest</button>
                    </div>
                    <div id="authMsgOverlay" class="auth-msg" aria-live="polite"></div>
                </div>
            </div>
        </div>
        
        <div class="content">

            <!-- Curve Type Selector, Encryption Selector, and Demonstrations Selector -->
            <div class="selector-row">
                <div class="curve-selector-dropdown">
                    <button class="curve-selector-btn" id="curveSelectorBtn">
                        <span>Curve view</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="curve-dropdown-menu">
                        <div class="curve-dropdown-item active" onclick="selectCurveType('fpTab', 'Curve over Fp')">Curve over Fp</div>
                        <div class="curve-dropdown-item" onclick="selectCurveType('realTab', 'Curve over ℝ')">Curve over ℝ</div>
                    </div>
                </div>

                <div class="curve-selector-dropdown">
                    <button class="curve-selector-btn" id="encryptionSelectorBtn">
                        <span>Crypto workflow</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="curve-dropdown-menu">
                        <div class="curve-dropdown-item active" onclick="selectEncryptionPane('encryptInitPane', event)">Initialization</div>
                    </div>
                </div>

                <div class="curve-selector-dropdown">
                    <button class="curve-selector-btn" id="demonstrationSelectorBtn">
                        <span>Interactive demos</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="curve-dropdown-menu">
                        <div class="curve-dropdown-item active" onclick="selectDemonstrationPane('dhDemoPane', event)">Diffie-Hellman</div>
                        <div class="curve-dropdown-item" onclick="selectDemonstrationPane('discreteLogPane', event)">Discrete Logarithm</div>
                    </div>
                </div>

            </div>

            <!-- About Modal -->
            <div id="aboutModal" class="about-modal">
                <div class="about-modal-overlay" onclick="closeAboutModal()"></div>
                <div class="about-modal-content">
                    <button class="about-modal-close" onclick="closeAboutModal()" aria-label="Close about">×</button>
                    <div class="about-modal-body">
                <div class="panel full-width">
                    <h2>About</h2>
                    <p style="margin-bottom: 12px; color:#ccc;">
                        Every UI panel, canvas, and API call here is focused on making elliptic-curve cryptography approachable without sacrificing rigor. You explore curves, run demonstrations, encrypt/decrypt data, and inspect the full history from a single dashboard.
                    </p>

                    <div class="math-formula">y² = x³ + ax + b (mod p)</div>

                    <h3 style="color:#000000; margin-top:16px;">Curve Exploration Workflow</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; color:#ccc;">
                        <li><strong>Initialization:</strong> Select a preset curve or enter custom <code>a</code>, <code>b</code>, and prime <code>p</code>. The system calculates the full finite field group (including the point at infinity) so you can map the geometry.</li>
                        <li><strong>Visualization:</strong> Two synchronized canvases plot all points with optional labels, color-coded highlights, and click-to-select behaviour so you can interrogate the group law visually.</li>
                        <li><strong>Point Operations:</strong> The addition and scalar multiplication panels guide you through the algebraic steps, show animated point movement, and keep transcripts ready to copy as JSON/LaTeX.</li>
                        <li><strong>Real/Finite Comparison:</strong> The ℝ tab mirrors the workflow over the reals, while the finite field tab stays true to modular arithmetic, letting you contrast the geometry.</li>
                    </ul>

                    <h3 style="color:#000000; margin-top:16px;">Demonstrations &amp; Learning</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; color:#ccc;">
                        <li><strong>Diffie-Hellman:</strong> Run a live handshake using the current curve, watch Alice/Bob compute shared secrets, and scrub through animated steps with the slider, auto-scroll, and canvas highlights.</li>
                        <li><strong>Discrete Logarithm:</strong> Select a scalar <code>k</code>, optionally prefer Baby-step Giant-step, and the demo exhausts attempts with metadata, time estimates, and a human-friendly summary.</li>
                        <li><strong>Tutorial player:</strong> Contextual tutorials are available from the menu, each explaining curve initialization, point addition, and other core concepts with inline animations.</li>
                        <li><strong>Interactive explanations:</strong> Expandable cards describe associativity, identity, inverses, smoothness, and why ECC is hard—each tied to animations inside the visualization area.</li>
                    </ul>

                    <h3 style="color:#000000; margin-top:16px;">Encryption &amp; History</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; color:#ccc;">
                        <li><strong>Encryption workflow:</strong> Generate ephemeral keys, encrypt text or uploaded files, and follow the step-by-step animation that draws R/S points, ciphertext batches, and shared secrets.</li>
                        <li><strong>Decryption workflow:</strong> Paste or drop ciphertext, decrypt with the stored private key, and see how the shared secret reassembles the plaintext; a guided "show steps" view mirrors the same animation.</li>
                        <li><strong>History database:</strong> Every curve initialization, parameter change, point addition/multiplication, encryption, and decryption is logged into the SQLite history table. You can export operations, replay demonstrations, and copy JSON summaries directly from the sliding history panel.</li>
                    </ul>

                    <h3 style="color:#000000; margin-top:16px;">Advanced Utilities</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; color:#ccc;">
                        <li><strong>Point classification:</strong> Use the advanced API to identify generators, torsion points, and their orders—perfect for understanding subgroup structure.</li>
                        <li><strong>Preset management:</strong> The dropdown keeps curated educational curves and lets you save custom presets with descriptions for future work.</li>
                        <li><strong>Exports:</strong> Generate test vectors, download point lists as CSV/JSON, or copy curve parameters/test results with a single click.</li>
                        <li><strong>Theme &amp; shortcuts:</strong> Toggle dark/light mode with the floating menu icon, use keyboard helpers, and watch toasts confirm actions.</li>
                    </ul>

                    <h3 style="color:#000000; margin-top:16px;">Why Elliptic Curves?</h3>
                    <p style="margin: 8px 0; color:#ccc;">
                        These curves form a compact, high-security group where the discrete logarithm problem remains hard. This interface makes every layer—from the algebra to encrypted messages and tutorials—visible so you can both experiment and explain ECC confidently.
                    </p>
                </div>
                    </div>
                </div>
            </div>

            <!-- Real Curve (ℝ) Tab -->
            <div id="realTab" class="tab-pane">

                <div id="realInitPane" class="subtab-pane active">
                    <div class="panel">
                        <h2>Define Curve</h2>
                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="realParamA">a</label>
                                    <input type="number" step="any" id="realParamA" value="-1" placeholder="a">
                                </div>
                                <div>
                                    <label for="realParamB">b</label>
                                    <input type="number" step="any" id="realParamB" value="1" placeholder="b">
                                </div>
                            </div>
                        </div>
                        <button onclick="initRealCurve()">Initialize Curve</button>

                        <div style="margin-top: 20px;">
                            <h3 style="color: #888; margin-bottom: 10px;">Operations</h3>
                            <button onclick="switchSubtab('real','realAddPane')" style="margin-bottom: 10px; width: 100%;">Point Addition</button>
                            <button onclick="switchSubtab('real','realMulPane')" style="width: 100%;">Scalar Multiplication</button>
                        </div>
                    </div>
                    <div class="panel">
                        <h2>Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Smooth curve plot over real numbers</p>
                        <canvas id="realCurveCanvas" width="600" height="500"></canvas>
                        <label style="display:block; margin-top:8px; color:#aaa; font-size:0.95em;">
                            <input id="realShowLabels" type="checkbox" checked onchange="redrawRealCanvases()"> Show point labels
                        </label>
                    </div>
                </div>

                <div id="realAddPane" class="subtab-pane">
                    <div class="panel">
                        <button onclick="switchSubtab('real','realInitPane')" style="margin-bottom: 15px;">← Back to Initialization</button>
                        <h2>Point Addition (ℝ)</h2>
                        <p style="margin-bottom: 15px; color: #888;">Geometric chord/tangent visualization</p>
                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="realP1X">P.x</label>
                                    <input type="number" step="any" id="realP1X" placeholder="x₁">
                                </div>
                                <div>
                                    <label for="realP1Y">P.y</label>
                                    <input type="number" step="any" id="realP1Y" placeholder="y₁">
                                </div>
                                <div>
                                    <label for="realSelectMode">Pick Mode</label>
                                    <select id="realSelectMode">
                                        <option value="P">Select P</option>
                                        <option value="Q">Select Q</option>
                                    </select>
                                </div>
                            </div>
                            <div class="point-status" id="realPoint1Status">Enter both coordinates</div>
                        </div>
                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="realP2X">Q.x</label>
                                    <input type="number" step="any" id="realP2X" placeholder="x₂">
                                </div>
                                <div>
                                    <label for="realP2Y">Q.y</label>
                                    <input type="number" step="any" id="realP2Y" placeholder="y₂">
                                </div>
                                <div>
                                    <label>&nbsp;</label>
                                    <button onclick="addPointsReal()">Calculate P + Q</button>
                                </div>
                            </div>
                            <div class="point-status" id="realPoint2Status">Enter both coordinates</div>
                        </div>
                        <div id="realAdditionResult"></div>
                    </div>
                    <div class="panel">
                        <h2>Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Click on the curve to set P or Q</p>
                        <canvas id="realAdditionCanvas" width="600" height="500"></canvas>
                        <label style="display:block; margin-top:8px; color:#aaa; font-size:0.95em;">
                            <input id="realAdditionShowLabels" type="checkbox" checked onchange="drawRealAdditionScene()"> Show point labels
                        </label>
                        <div class="steps-toggle-row">
                            <button id="realAdditionToggleStepsBtn" class="toggle-steps-btn" type="button" onclick="toggleStepsDisplay('realAddition')" data-visible="true">
                                Hide steps
                            </button>
                        </div>
                    </div>
                </div>

                <div id="realMulPane" class="subtab-pane">
                    <div class="panel">
                        <button onclick="switchSubtab('real','realInitPane')" style="margin-bottom: 15px;">← Back to Initialization</button>
                        <h2>Scalar Multiplication (ℝ)</h2>
                        <p style="margin-bottom: 15px; color: #888;">Follow k × P along the curve</p>
                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="realK">k</label>
                                    <input type="number" id="realK" value="3" placeholder="k">
                                </div>
                                <div>
                                    <label for="realMulPX">P.x</label>
                                    <input type="number" step="any" id="realMulPX" placeholder="x">
                                </div>
                                <div>
                                    <label for="realMulPY">P.y</label>
                                    <input type="number" step="any" id="realMulPY" placeholder="y">
                                </div>
                            </div>
                            <div class="point-status" id="realScalarPointStatus">Enter both coordinates</div>
                        </div>
                        <button onclick="scalarMultiplyReal()">Calculate k × P</button>
                        <div id="realScalarResult"></div>
                    </div>
                    <div class="panel">
                        <h2>Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Visualization</p>
                        <canvas id="realMultiplicationCanvas" width="600" height="500"></canvas>
                        <label style="display:block; margin-top:8px; color:#aaa; font-size:0.95em;">
                            <input id="realMultiplicationShowLabels" type="checkbox" checked onchange="renderRealScalarAll()"> Show point labels
                        </label>
                        <div class="steps-toggle-row">
                            <button id="realScalarToggleStepsBtn" class="toggle-steps-btn" type="button" onclick="toggleStepsDisplay('realScalar')" data-visible="true">
                                Hide steps
                            </button>
                        </div>
                        <div id="realAnimControls" class="anim-controls" style="display:none;"></div>
                    </div>
                </div>

            </div>

            <!-- Curve over Fp Tab -->
            <div id="fpTab" class="tab-pane active">

                <div id="fpInitPane" class="subtab-pane active">
                    <div class="panel">
                        <h2>Define Curve</h2>
                        <div class="form-group">
                            <label for="curvePreset">Preset Curves</label>
                            <select id="curvePreset" onchange="loadCurvePreset(this.value)">
                                <option value="custom">Custom</option>
                                <optgroup label="Famous Curves (Simplified)">
                                    <option value="secp256k1">secp256k1-like (Bitcoin)</option>
                                    <option value="p256">P-256-like (NIST)</option>
                                </optgroup>
                                <optgroup label="Small Examples">
                                    <option value="e23">E₂₃(1,1) - Tiny example</option>
                                    <option value="e31">E₃₁(2,3) - Small example</option>
                                    <option value="e47">E₄₇(5,7) - Medium example</option>
                                    <option value="e97" selected>E₉₇(2,3) - Default</option>
                                    <option value="e127">E₁₂₇(1,2) - Larger example</option>
                                </optgroup>
                            </select>
                            <small id="curveDescription" class="curve-description"></small>
                        </div>
                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="paramA">a</label>
                                    <input type="number" id="paramA" value="2" placeholder="a">
                                </div>
                                <div>
                                    <label for="paramB">b</label>
                                    <input type="number" id="paramB" value="3" placeholder="b">
                                </div>
                                <div>
                                    <label for="paramP">p (prime)</label>
                                    <input type="number" id="paramP" value="97" placeholder="p">
                                </div>
                            </div>
                        </div>
                        <button onclick="findAllPoints()">Find All Points on Curve</button>

                        <div style="margin-top: 20px;">
                            <h3 style="color: #888; margin-bottom: 10px;">Operations</h3>
                            <button onclick="switchSubtab('fp','fpAddPane')" style="margin-bottom: 10px; width: 100%;">Point Addition</button>
                            <button onclick="switchSubtab('fp','fpMulPane')" style="width: 100%; margin-bottom: 10px;">Scalar Multiplication</button>
                            <button onclick="classifyPoints()" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Classify Points</button>
                        </div>
                    </div>
                    <div class="panel">
                        <h2>Points</h2>
                        <div id="curveInfo"></div>
                        <div id="pointsList"></div>

                    </div>
                </div>

                <div id="fpAddPane" class="subtab-pane">
                    <div class="panel">
                        <button onclick="switchSubtab('fp','fpInitPane')" style="margin-bottom: 15px;">← Back to Initialization</button>
                        <h2>Point Addition</h2>
                        <p style="margin-bottom: 15px; color: #888;">Add two points: P + Q = R</p>
                        <div class="form-group">
                            <label for="point1Select">Point P</label>
                            <select id="point1Select"><option value="">Select Point P</option></select>
                        </div>
                        <div class="form-group">
                            <label for="point2Select">Point Q</label>
                            <select id="point2Select"><option value="">Select Point Q</option></select>
                        </div>
                        <button onclick="addPoints()">Calculate P + Q</button>
                        <div id="additionResult"></div>
                    </div>
                    <div class="panel">
                        <h2>Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Points on the elliptic curve (mod p)</p>
                        <canvas id="additionCanvas" width="600" height="500"></canvas>
                        <label style="display:block; margin-top:8px; color:#aaa; font-size:0.95em;">
                            <input id="additionShowLabels" type="checkbox" checked onchange="redrawAdditionCanvas()"> Show point labels
                        </label>
                        <div class="steps-toggle-row">
                            <button id="additionToggleStepsBtn" class="toggle-steps-btn" type="button" onclick="toggleStepsDisplay('addition')" data-visible="true">
                                Hide steps
                            </button>
                        </div>
                        <div id="additionPointInfo" class="point-info" aria-live="polite"></div>
                    </div>
                </div>

                <div id="fpMulPane" class="subtab-pane">
                    <div class="panel">
                        <button onclick="switchSubtab('fp','fpInitPane')" style="margin-bottom: 15px;">← Back to Initialization</button>
                        <h2>Scalar Multiplication</h2>
                        <p style="margin-bottom: 15px; color: #888;">Multiply a point by a scalar: k × P</p>
                        <div class="form-group">
                            <label for="scalarPointSelect">Point P</label>
                            <select id="scalarPointSelect"><option value="">Select Point P</option></select>
                        </div>
                        <div class="form-group">
                            <label for="scalarValue">Scalar k</label>
                            <input type="number" id="scalarValue" value="3" placeholder="k">
                        </div>
                        <button onclick="scalarMultiply()">Calculate k × P</button>
                        <div id="scalarResult"></div>
                    </div>
                    <div class="panel">
                        <h2>Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Visualization</p>
                        <canvas id="multiplicationCanvas" width="600" height="500"></canvas>
                        <label style="display:block; margin-top:8px; color:#aaa; font-size:0.95em;">
                            <input id="multiplicationShowLabels" type="checkbox" checked onchange="renderFpScalarAll()"> Show point labels
                        </label>
                        <div class="steps-toggle-row">
                            <button id="scalarToggleStepsBtn" class="toggle-steps-btn" type="button" onclick="toggleStepsDisplay('scalar')" data-visible="true">
                                Hide steps
                            </button>
                        </div>
                        <div id="multiplicationPointInfo" class="point-info" aria-live="polite"></div>
                        <div id="animationControls" class="anim-controls" style="display:none;">
                            <button id="prevStepBtn" onclick="prevScalarStep()" disabled>Prev</button>
                            <button id="playPauseBtn" onclick="toggleScalarAnimation()" disabled>Play</button>
                            <input id="stepSlider" type="range" min="0" max="0" value="0" disabled oninput="onScalarSlider(this.value)">
                            <button id="nextStepBtn" onclick="nextScalarStep()" disabled>Next</button>
                            <span id="stepLabel" class="step-label">0/0</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Demonstrations Tab -->
            <div id="demonstrationsTab" class="tab-pane">
                <div id="dhDemoPane" class="subtab-pane active">
                    <div class="panel">
                        <h2>Diffie-Hellman Key Exchange</h2>
                        <p style="margin-bottom: 15px; color: #888;">Interactive demonstration of ECDH protocol</p>

                        <div class="form-group">
                            <label for="dhCurvePreset">Preset Curves</label>
                            <select id="dhCurvePreset" onchange="loadDHPreset(this.value)">
                                <option value="e23">E₂₃(1,1) - Tiny example</option>
                                <option value="e31">E₃₁(2,3) - Small example</option>
                                <option value="e47" selected>E₄₇(5,7) - Medium example</option>
                                <option value="e97">E₉₇(2,3) - Default</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="dhParamA">a</label>
                                    <input type="number" id="dhParamA" value="5" placeholder="a">
                                </div>
                                <div>
                                    <label for="dhParamB">b</label>
                                    <input type="number" id="dhParamB" value="7" placeholder="b">
                                </div>
                                <div>
                                    <label for="dhParamP">p (prime)</label>
                                    <input type="number" id="dhParamP" value="47" placeholder="p">
                                </div>
                            </div>
                        </div>

                        <button onclick="runDiffieHellmanDemo()">Start Diffie-Hellman Demo</button>

                        <div id="dhDemoResult"></div>
                    </div>
                    <div class="panel">
                        <h2>Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Step-by-step walkthrough</p>
                        <div id="dhStepsContainer" style="max-height: 350px; overflow-y: auto;"></div>
                        <div class="dh-canvas-wrapper" style="margin-top: 20px;">
                            <canvas id="dhCanvas" width="620" height="420" style="width: 100%; height: auto; border-radius: 12px; background: var(--bg-tertiary); display: none;"></canvas>
                            <p id="dhCanvasHint" style="margin: 10px 0 0; color: var(--text-muted); font-size: 0.85em; text-align: center;">
                                The canvas illustrates Alice, Bob, and the shared secret. Run the demo to reveal each step.
                            </p>
                        </div>

                        <div id="dhAnimControls" class="anim-controls" style="display:none; margin-top: 20px;">
                            <button id="dhPrevBtn" onclick="prevDHStep()">Previous</button>
                            <button id="dhPlayBtn" onclick="playDHAnimation()">Play</button>
                            <input id="dhStepSlider" type="range" min="0" max="0" value="0" oninput="setDHStep(this.value)">
                            <button id="dhNextBtn" onclick="nextDHStep()">Next</button>
                            <span class="step-label" id="dhStepLabel">0/0</span>
                        </div>
                    </div>
                </div>

                <div id="discreteLogPane" class="subtab-pane">
                    <div class="panel">
                        <h2>Discrete Logarithm Problem</h2>
                        <p style="margin-bottom: 15px; color: #888;">Interactive demonstration of computational hardness</p>

                        <div class="form-group">
                            <label for="dlogCurvePreset">Preset Curves</label>
                            <select id="dlogCurvePreset" onchange="loadDLogPreset(this.value)">
                                <option value="e23">E₂₃(1,1) - Tiny example</option>
                                <option value="e31">E₃₁(2,3) - Small example</option>
                                <option value="e47" selected>E₄₇(5,7) - Medium example</option>
                                <option value="e97">E₉₇(2,3) - Default</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="dlogParamA">a</label>
                                    <input type="number" id="dlogParamA" value="5" placeholder="a">
                                </div>
                                <div>
                                    <label for="dlogParamB">b</label>
                                    <input type="number" id="dlogParamB" value="7" placeholder="b">
                                </div>
                                <div>
                                    <label for="dlogParamP">p (prime)</label>
                                    <input type="number" id="dlogParamP" value="47" placeholder="p">
                                </div>
                            </div>
                        </div>

                    <div class="form-group">
                        <label for="dlogScalar">Scalar k (1-2000)</label>
                        <input type="number" id="dlogScalar" value="5" min="1" max="2000" placeholder="k">
                    </div>

                    <div class="form-group">
                        <label class="checkbox-inline">
                            <input type="checkbox" id="dlogUseBsgs" checked>
                            Prefer Baby-step Giant-step when k is large
                        </label>
                        <small style="display:block; margin-top:4px; color: var(--text-muted);">
                            BSGS speeds up the demo for large scalars (k &gt; 100) but shows fewer explicit steps.
                        </small>
                    </div>

                        <button onclick="runDiscreteLogDemo()">Start Discrete Log Demo</button>

                        <div id="dlogDemoResult"></div>
                    </div>
                    <div class="panel">
                        <h2>Brute Force Attempts</h2>
                        <p style="margin-bottom: 15px; color: #888;">Watch the algorithm try to find k</p>
                        <div id="dlogStepsContainer" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Encryption Tab -->
            <div id="encryptionTab" class="tab-pane">
                <div id="encryptInitPane" class="subtab-pane active">
                    <div class="panel">
                        <h2>Setup Encryption</h2>
                        <div class="form-group">
                            <label for="encryptionPreset">Preset Curves</label>
                            <select id="encryptionPreset" onchange="loadEncryptionPreset(this.value)">
                                <option value="custom">Custom</option>
                                <option value="e23">E₂₃(1,1) - Tiny example</option>
                                <option value="e31">E₃₁(2,3) - Small example</option>
                                <option value="e47" selected>E₄₇(5,7) - Medium example</option>
                                <option value="e97">E₉₇(2,3) - Larger example</option>
                            </select>
                            <small id="encryptionCurveDesc" class="curve-description"></small>
                        </div>
                        <div class="form-group">
                            <div class="inline-inputs">
                                <div>
                                    <label for="encryptParamA">a</label>
                                    <input type="number" id="encryptParamA" value="5" placeholder="a">
                                </div>
                                <div>
                                    <label for="encryptParamB">b</label>
                                    <input type="number" id="encryptParamB" value="7" placeholder="b">
                                </div>
                                <div>
                                    <label for="encryptParamP">p (prime)</label>
                                    <input type="number" id="encryptParamP" value="47" placeholder="p">
                                </div>
                            </div>
                        </div>
                        <button onclick="initEncryptionCurve()">Initialize Encryption System</button>
                        <div id="encryptionSystemInfo"></div>

                        <div style="margin-top: 20px;">
                            <h3 style="color: #888; margin-bottom: 10px;">Operations</h3>
                            <button onclick="selectEncryptionPane('encryptPane')" style="margin-bottom: 10px; width: 100%;" id="encryptOperationBtn" disabled>Encrypt Message</button>
                            <button onclick="selectEncryptionPane('decryptPane')" style="width: 100%;" id="decryptOperationBtn" disabled>Decrypt Message</button>
                        </div>
                    </div>
                    <div class="panel">
                        <h2>Key Information</h2>
                        <div id="encryptionKeyInfo"></div>
                    </div>
                </div>

                <div id="encryptPane" class="subtab-pane">
                    <div class="panel">
                        <button onclick="selectEncryptionPane('encryptInitPane')" style="margin-bottom: 15px;">← Back to Setup</button>
                        <h2>Encrypt Message</h2>
                        <p style="margin-bottom: 15px; color: #888;">Encrypt text using elliptic curve cryptography</p>
                        <div class="form-group">
                            <label for="plaintextInput">Message to Encrypt</label>
                            <textarea id="plaintextInput" rows="4" placeholder="Enter your message here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="encryptionFileInput">Or upload a file</label>
                            <input type="file" id="encryptionFileInput">
                            <small style="color:#aaa;">File bytes will be encrypted instead of the text above.</small>
                        </div>
                        <button onclick="encryptMessage()">Encrypt</button>
                        <div id="encryptionResult"></div>
                        <div id="encryptionStepsDisplay" class="steps-display"></div>
                    </div>
                    <div class="panel">
                        <h2>Encryption Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Watch the encryption process step by step</p>
                        <canvas id="encryptionCanvas" width="600" height="500"></canvas>
                        <div class="steps-toggle-row">
                            <button id="encryptionToggleStepsBtn" class="toggle-steps-btn" type="button" onclick="toggleStepsDisplay('encryption')" data-visible="true">
                                Hide steps
                            </button>
                        </div>
                    </div>
                </div>

                <div id="decryptPane" class="subtab-pane">
                    <div class="panel">
                        <button onclick="selectEncryptionPane('encryptInitPane')" style="margin-bottom: 15px;">← Back to Setup</button>
                        <h2>Decrypt Message</h2>
                        <p style="margin-bottom: 15px; color: #888;">Decrypt ciphertext using your private key</p>
                        <div class="form-group">
                            <label for="ciphertextInput">Ciphertext (JSON format)</label>
                            <textarea id="ciphertextInput" rows="6" placeholder='{"R": {"x": ..., "y": ...}, "encrypted": [...], "iv": ...}'></textarea>
                        </div>
                        <div class="form-group">
                            <label for="decryptionFileInput">Or upload ciphertext file</label>
                            <input type="file" id="decryptionFileInput" accept=".json,application/json">
                            <small style="color:#aaa;">Only JSON ciphertext files are allowed.</small>
                        </div>
                        <button onclick="decryptMessage()">Decrypt</button>
                        <div id="decryptionResult"></div>
                        <div id="decryptionStepsDisplay" class="steps-display"></div>
                    </div>
                    <div class="panel">
                        <h2>Decryption Visualization</h2>
                        <p style="margin-bottom: 15px; color: #888;">Watch the decryption process step by step</p>
                        <canvas id="decryptionCanvas" width="600" height="500"></canvas>
                        <div class="steps-toggle-row">
                            <button id="decryptionToggleStepsBtn" class="toggle-steps-btn" type="button" onclick="toggleStepsDisplay('decryption')" data-visible="true">
                                Hide steps
                            </button>
                        </div>
                    </div>
                </div>

        </div>
    </div>

    <!-- Floating ECC Expert Chat -->
    <div class="chat-assistant" aria-live="polite">
        <button id="chatToggleBtn" class="chat-fab" aria-label="Open ECC expert chat">
            <i class="fa-solid fa-robot"></i>
        </button>
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <div>
                    <div class="chat-title">ECC Expert</div>
                    <div class="chat-subtitle">Ask about curves, keys, or crypto flow</div>
                </div>
                <div class="chat-header-actions">
                    <span id="chatStatus" class="chat-status">Ready</span>
                    <button id="chatCloseBtn" class="chat-close-btn" aria-label="Close chat">×</button>
                </div>
            </div>
            <div id="chatMessages" class="chat-messages">
                <div class="chat-message bot">
                    <div class="chat-avatar"><i class="fa-solid fa-wave-square" aria-hidden="true"></i></div>
                    <div class="chat-bubble">
                        Hi! I’m your elliptic-curve guide. Ask me how to pick base points, verify group laws, or troubleshoot key exchange.
                    </div>
                </div>
            </div>
            <form id="chatForm" class="chat-input-area">
                <textarea id="chatInput" rows="2" placeholder="Ask how to choose p, find generators, or compute kP fast..." required></textarea>
                <button type="submit" class="chat-send-btn">
                    <span class="send-label">Send</span>
                    <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
                </button>
            </form>
        </div>
    </div>

            <script src="{{ url_for('static', filename='js/calculator.js') }}"></script>

</html>
